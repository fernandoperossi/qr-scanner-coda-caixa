<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Escanear QR Code</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 8px; }
    #status { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <h2>Escanear QR Code</h2>
  <video id="preview"></video>
  <div id="status">Aguardando leitura...</div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // ‚ö†Ô∏è Configure aqui seus dados do Coda
    const CODA_API_KEY = "COLE_SUA_API_KEY_AQUI"; // substitua pela sua API Key
    const DOC_ID = "SEU_DOC_ID";                  // ex: abcD1234
    const TABLE_ID = "Scanner";                   // ID ou nome da tabela

    const statusDiv = document.getElementById("status");

    function enviarParaCoda(qrCodeValue) {
      statusDiv.innerHTML = "üì§ Enviando para Coda...";

      return fetch(`https://coda.io/apis/v1/docs/${DOC_ID}/tables/${TABLE_ID}/rows`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + CODA_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          rows: [
            {
              cells: [
                { column: "qr_code", value: qrCodeValue } // ajuste "qr_code" para o nome real da coluna
              ]
            }
          ]
        })
      })
      .then(async res => {
        if (!res.ok) {
          const erro = await res.text();
          throw new Error(`Erro ${res.status}: ${erro}`);
        }
        statusDiv.innerHTML = "‚úÖ Salvo no Coda!";
        setTimeout(() => { window.close(); }, 1500); // fecha a aba ap√≥s 1,5s
      })
      .catch(err => {
        statusDiv.innerHTML = "‚ùå Erro ao enviar:<br>" + err.message;
        console.error(err);
      });
    }

    function startScanner() {
      const html5QrCode = new Html5Qrcode("preview");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              statusDiv.innerHTML = "QR lido: " + qrCodeMessage;
              html5QrCode.stop().then(() => {
                enviarParaCoda(qrCodeMessage);
              });
            },
            errorMessage => {
              console.warn("Erro scan:", errorMessage);
            }
          );
        } else {
          statusDiv.innerHTML = "‚ùå Nenhuma c√¢mera encontrada.";
        }
      }).catch(err => {
        statusDiv.innerHTML = "‚ùå Erro ao acessar c√¢mera: " + err;
      });
    }

    window.onload = startScanner;
  </script>
</body>
</html>
